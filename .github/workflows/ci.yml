name: Kazoo CI

on:
  push:
    branches: [ master, main ]
  pull_request:

env:
  KAZOO_ROOT: ${{ github.workspace }}

jobs:

# ---------------- SETUP ----------------
  setup:
    runs-on: ubuntu-latest
    container:
      image: offical2600hz/circleci:22.3
    steps:
      - uses: actions/checkout@v4

      - name: Listing Changes
        run: make changed

      - name: Upload workspace
        uses: actions/upload-artifact@v4
        with:
          name: workspace
          path: .

# ---------------- BUILD DEPS ----------------
  build_deps:
    needs: setup
    runs-on: ubuntu-latest
    container:
      image: offical2600hz/circleci:22.3

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: workspace
          path: .

      - name: Restore deps cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            .git/.kz_deps_hash
          key: deps-${{ hashFiles('make/deps.mk') }}

      - name: Make dependencies
        run: make deps

# ---------------- BUILD ----------------
  build:
    needs: build_deps
    runs-on: ubuntu-latest
    container:
      image: offical2600hz/circleci:22.3

    steps:
      - uses: actions/checkout@v4

      - name: Restore deps cache
        uses: actions/cache@v4
        with:
          path: deps
          key: deps-${{ hashFiles('make/deps.mk') }}

      - name: Compile
        run: JOBS="2" make

# ---------------- TESTS ----------------
  eunit_tests:
    needs: build_deps
    runs-on: ubuntu-latest
    container:
      image: offical2600hz/circleci:22.3

    steps:
      - uses: actions/checkout@v4

      - name: Compile test env
        run: ERLC_OPTS='-DPROPER' make compile-test

      - name: Run tests
        run: make eunit

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: junit
          path: "**/TEST-*.xml"

# ---------------- CHECKS ----------------
  checks:
    needs: build
    runs-on: ubuntu-latest
    container:
      image: offical2600hz/circleci:22.3

    steps:
      - uses: actions/checkout@v4

      - run: make fmt
      - run: make code_checks
      - run: make app_applications
      - run: make sup_completion
      - run: make xref
      - run: make elvis
      - run: scripts/check-unstaged.bash

# ---------------- DOCS ----------------
  docs:
    needs: build
    runs-on: ubuntu-latest
    container:
      image: offical2600hz/circleci:22.3

    steps:
      - uses: actions/checkout@v4

      - run: make apis
      - run: make validate-js
      - run: make validate-schemas
      - run: make docs
      - run: scripts/state-of-docs.py || true
      - run: scripts/state-of-edoc.escript
      - run: scripts/check-unstaged.bash

# ---------------- ANALYZE ----------------
  analyze:
    needs: build
    runs-on: ubuntu-latest
    container:
      image: offical2600hz/circleci:22.3

    steps:
      - uses: actions/checkout@v4

      - name: Restore PLT cache
        uses: actions/cache@v4
        with:
          path: .kazoo.plt
          key: plt-${{ hashFiles('make/deps.mk') }}

      - run: make build-plt
      - run: make dialyze-changed

# ---------------- RELEASE ----------------
  release:
    needs: build
    runs-on: ubuntu-latest
    container:
      image: offical2600hz/circleci:22.3

    services:
      couchdb:
        image: couchdb:3.0
        ports: ["5984:5984"]
        env:
          COUCHDB_USER: admin
          COUCHDB_PASSWORD: admin

      rabbitmq:
        image: 2600hz/rabbitmq

    steps:
      - uses: actions/checkout@v4

      - name: Build CI release
        run: make build-ci-release

      - name: Run Kazoo release
        run: |
          KAZOO_CONFIG=${PWD}/rel/ci.config.ini \
          REL="kazoo_apps" \
          ACT="console" \
          NODE_NAME_TYPE="-sname" \
          make release

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kazoo-release
          path: |
            _rel/kazoo/releases/**/kazoo.rel
            rel/ci.relx.config
