name: Kazoo CI

on:
  push:
    branches: [ master ]
  pull_request:

env:
  WORKDIR: ~/2600hz/kazoo

jobs:

# ---------------- SETUP ----------------
  setup:
    runs-on: ubuntu-latest
    container: offical2600hz/circleci:22.3
    options: --user 0
    steps:
      - uses: actions/checkout@v4

      - name: Listing Changes
        run: make changed

      - name: Upload workspace
        uses: actions/upload-artifact@v4
        with:
          name: workspace
          path: .

# ---------------- BUILD DEPS ----------------
  build_deps:
    needs: setup
    runs-on: ubuntu-latest
    container: offical2600hz/circleci:22.3
    options: --user 0
    steps:
      - uses: actions/checkout@v4

      - name: Restore deps cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            .git/.kz_deps_hash
          key: deps-${{ hashFiles('make/deps.mk') }}

      - name: Make dependencies
        run: make deps

# ---------------- BUILD ----------------
  build:
    needs: build_deps
    runs-on: ubuntu-latest
    container: offical2600hz/circleci:22.3
    options: --user 0
    steps:
      - uses: actions/checkout@v4

      - name: Compile project
        run: JOBS="2" make

# ---------------- TESTS ----------------
  eunit_tests:
    needs: build_deps
    runs-on: ubuntu-latest
    container: offical2600hz/circleci:22.3
    options: --user 0
    steps:
      - uses: actions/checkout@v4

      - name: Compile for tests
        run: ERLC_OPTS='-DPROPER' make compile-test

      - name: Run EUnit
        run: make eunit

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit
          path: "**/TEST-*.xml"

# ---------------- CHECKS ----------------
  checks:
    needs: build
    runs-on: ubuntu-latest
    container: offical2600hz/circleci:22.3
    options: --user 0
    steps:
      - uses: actions/checkout@v4
      - run: make fmt
      - run: make code_checks
      - run: make app_applications
      - run: make sup_completion
      - run: make xref
      - run: make elvis
      - run: scripts/check-unstaged.bash

# ---------------- DOCS ----------------
  docs:
    needs: build
    runs-on: ubuntu-latest
    container: offical2600hz/circleci:22.3
    options: --user 0
    steps:
      - uses: actions/checkout@v4
      - run: make apis
      - run: make validate-js
      - run: make validate-schemas
      - run: make docs
      - run: scripts/state-of-docs.py || true
      - run: scripts/state-of-edoc.escript
      - run: scripts/check-unstaged.bash

# ---------------- ANALYZE ----------------
  analyze:
    needs: build
    runs-on: ubuntu-latest
    container: offical2600hz/circleci:22.3
    options: --user 0
    steps:
      - uses: actions/checkout@v4

      - name: Restore Dialyzer cache
        uses: actions/cache@v4
        with:
          path: .kazoo.plt
          key: plt-${{ hashFiles('make/deps.mk') }}

      - run: make build-plt
      - run: make dialyze-changed

# ---------------- RELEASE ----------------
  release:
    needs: build
    runs-on: ubuntu-latest

    container: offical2600hz/circleci:22.3
    options: --user 0
    services:
      couchdb:
        image: couchdb:3.0
        env:
          COUCHDB_USER: admin
          COUCHDB_PASSWORD: admin
        ports:
          - 5984:5984

      rabbitmq:
        image: 2600hz/rabbitmq
        ports:
          - 5672:5672

    steps:
      - uses: actions/checkout@v4

      - name: Create artifact dir
        run: mkdir -p /tmp/artifacts

      - name: Build CI release
        run: make build-ci-release

      - name: Run Kazoo release
        run: |
          KAZOO_CONFIG=${PWD}/rel/ci.config.ini \
          REL="kazoo_apps" \
          ACT="console" \
          NODE_NAME_TYPE="-sname" \
          make release

      - name: Copy artifacts
        run: |
          cp ${PWD}/rel/ci.relx.config /tmp/artifacts/
          find ${PWD}/_rel/kazoo/releases -name kazoo.rel -exec cp {} /tmp/artifacts/ \;

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kazoo-release
          path: /tmp/artifacts

      - name: Check release errors
        run: |
          if [[ $(grep -c -v -F 'exit with reason shutdown' /tmp/artifacts/log/error.log 2>/dev/null) -gt 0 ]]; then
            echo "Errors detected"
            cat /tmp/artifacts/log/error.log
            exit 1
          else
            echo "No errors in release"
          fi
